<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nueva Requisición</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root {
      --azul-principal: #3e5f8a;
      --azul-claro: #4f7ab3;
      --gris-fondo: #f4f6f8;
      --borde-suave: #e0e6ec;
    }
    body {
      background-color: var(--gris-fondo);
      font-family: 'Inter', 'Segoe UI', system-ui;
    }
    .strawberry-bar {
      background-color: var(--azul-principal);
      background-image: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.05)), url("{{ url_for('static', filename='img/fresa_pattern.svg') }}");
      background-size: 220px;
      background-repeat: repeat;
      background-position: center;
      color: #fff !important;
      border-bottom: 3px solid var(--azul-claro);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
      animation: movePattern 60s linear infinite;
    }
    .strawberry-bar .navbar-brand {
      font-weight: 600;
      color: #fff !important;
      letter-spacing: 0.5px;
    }
    .strawberry-bar .btn-light {
      background-color: rgba(255,255,255,0.9);
      border: none;
      color: var(--azul-principal);
    }
    .strawberry-bar .btn-light:hover {
      background-color: #fff;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .strawberry-bar .btn-danger {
      background-color: #e63946;
      border: none;
    }
    .strawberry-bar .btn-danger:hover {
      background-color: #c62835;
    }
    @keyframes movePattern {
      from { background-position:0 0; }
      to { background-position:400px 300px; }
    }
    .card {
      border-radius: 14px;
      border: 1px solid var(--borde-suave);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .card h4 {
      color: var(--azul-principal);
      font-weight: 600;
    }
    .form-label {
      font-weight: 500;
      color: #333;
    }
    .product-row {
      background: #fff;
      padding: 14px;
      border-radius: 10px;
      margin-bottom: 10px;
      border: 1px solid var(--borde-suave);
    }
    .btn-outline-primary {
      border-color: var(--azul-claro);
      color: var(--azul-principal);
    }
    .btn-outline-primary:hover {
      background-color: var(--azul-claro);
      color: #fff;
    }
    .btn-success {
      background-color: var(--azul-principal);
      border: none;
    }
    .btn-success:hover {
      background-color: var(--azul-claro);
    }
    footer {
      background-color: var(--azul-principal);
      color: #fff;
      text-align: center;
      padding: 10px 0;
      margin-top: 30px;
      font-size: 0.95rem;
    }
    @media (max-width: 768px) {
      .product-row .row > div { margin-bottom: 8px; }
    }
  </style>
</head>
<body>

  <!-- Barra superior -->
  <nav class="navbar shadow-sm strawberry-bar">
    <div class="container d-flex justify-content-between align-items-center">
      <a class="navbar-brand d-flex align-items-center text-white fw-semibold" href="#">
        <img src="{{ url_for('static', filename='logo.png') }}" style="height:34px" class="me-2">
        Requisiciones Latín Berry Plants
      </a>
      <div class="d-flex gap-2">
          <a class="btn btn-light btn-sm me-2" href="{{ url_for('mis_requisiciones') }}">Mis requisiciones</a>

          {% set is_jefe = (session.get('role') == 'jefe') %}
          {% if session.get('role') == 'admin' or is_jefe %}
            <a class="btn btn-light btn-sm me-2" href="{{ url_for('autorizaciones') }}">Autorizaciones</a>
          {% endif %}

          {% if session.get('role')=='admin' %}
            <a class="btn btn-light btn-sm me-2" href="{{ url_for('admin_products') }}">Admin</a>
          {% endif %}
          <a class="btn btn-danger btn-sm" href="{{ url_for('logout') }}">Salir</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <div class="card p-4">
      <h4>Crear requisición</h4>
      <small class='text-muted'>Agregar uno o varios productos</small>

      <form method="post" enctype="multipart/form-data">
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label">Departamento</label>
            <select id="departamento" name="departamento" class="form-select" required>
              {% for d in departments %}<option value="{{d}}">{{d}}</option>{% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Etapa</label>
            <select id="etapa" name="etapa" class="form-select" required></select>
               <div class="legend-contact text-muted">Si la opción es Capex, selecciona el proyecto al que pertenezca</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ubicación / Rancho</label>
            <select name="ubicacion" class="form-select" required>
              {% for l in locations %}<option value="{{l}}">{{l}}</option>{% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Motivo de Compras</label>
            <input name="motivo" class="form-control" required>
          </div>
        </div>

        <hr>

        <div id="productsContainer"></div>

        <div class="d-flex justify-content-between align-items-center mb-3">
          <button type="button" id="addProduct" class="btn btn-outline-primary">+ Agregar producto / servicio</button>
          <div class="legend-contact text-muted">Si el producto o servicio no aparece en el catálogo, contactar al área de Compras.</div>
        </div>

        <input type="hidden" name="products_json" id="products_json">

        <div class="d-flex justify-content-between mt-3">
          <!-- <button type="button" id="downloadExcel" class="btn btn-outline-primary">Descargar Excel</button>-->
          <button type="submit" class="btn btn-success">Enviar requisición</button>
        </div>
      </form>
    </div>
  </div>

  <datalist id="products_list">{% for p in products %}<option value="{{ p }}"></option>{% endfor %}</datalist>

  <!-- Librería SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <script>
    const stages = {{ stages|tojson }};
    const projects_by_dept = {{ projects_by_dept|tojson }};
    const units = {{ units|tojson }};

    function loadStages(dep){
      const etapaSel = document.getElementById('etapa'); etapaSel.innerHTML='';
      (stages[dep]||[]).forEach(s=>{ let o=document.createElement('option'); o.value=s;o.textContent=s; etapaSel.appendChild(o);});
    }

    function loadProjects(dep, select){
      select.innerHTML='';
      (projects_by_dept[dep]||[]).forEach(p=>{ 
        let o=document.createElement('option'); 
        o.value=p;
        o.textContent=p; 
        select.appendChild(o);
      });
      let other = document.createElement('option'); 
      other.value='__other__'; 
      other.textContent='-- Agregar proyecto especial --'; 
      select.appendChild(other);
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const dep=document.getElementById('departamento').value; 
      loadStages(dep);

      let idx=0;
      function addRow(){
        const container=document.getElementById('productsContainer');
        const row=document.createElement('div');
        row.className='product-row';
        row.dataset.index=idx;
        const depSel = document.getElementById('departamento').value;
        row.innerHTML = `
          <div class='row g-2 align-items-end'>
            <div class='col-md-3'>
              <label class='form-label'>Producto / Servicio</label>
              <input list="products_list" class='form-control prod-input' name='product_${idx}' required placeholder="Buscar producto o servicio">
            </div>
            <div class='col-md-3'>
              <label class='form-label'>Proyecto / Departamento</label>
              <div class="d-flex gap-2">
                <select class='form-select proyecto-select' name='proyecto_${idx}' required style="flex:1;"></select>
                <button type="button" class="btn btn-outline-secondary addProjBtn" title="Agregar proyecto especial">+</button>
              </div>
              <input type="text" class='form-control proyecto-especial mt-2' name='proyecto_especial_${idx}' placeholder="Nombre de proyecto especial (opcional)" style="display:none;">
            </div>
            <div class='col-md-2'>
              <label class='form-label'>Unidad</label>
              <select class='form-select unit-select' name='unit_${idx}' required>${units.map(u=>`<option value="${u}">${u}</option>`).join('')}</select>
            </div>
            <div class='col-md-2'>
              <label class='form-label'>Cantidad</label>
              <input type='number' class='form-control qty-input' name='qty_${idx}' min="1" step="0.01" required>
            </div>
            <div class='col-md-2'>
              <label class='form-label'>Imagen</label>
              <input type='file' class='form-control img-input' name='image_${idx}' accept='image/*'>
            </div>
            <div class='col-md-12 text-end'>
              <button type='button' class='btn btn-sm btn-outline-danger remove-btn mt-2'>Eliminar</button>
            </div>
          </div>`;
        container.appendChild(row);

        const proyectoSelect = row.querySelector('.proyecto-select');
        loadProjects(depSel, proyectoSelect);

        proyectoSelect.addEventListener('change', function(){
          const specialInput = row.querySelector('.proyecto-especial');
          if(this.value==='__other__'){
            specialInput.style.display='block';
          } else {
            specialInput.style.display='none';
            specialInput.value='';
          }
        });

        row.querySelector('.addProjBtn').addEventListener('click', function(){
          const specialInput = row.querySelector('.proyecto-especial');
          specialInput.style.display='block';
          proyectoSelect.value='__other__';
          specialInput.focus();
        });

        row.querySelector('.remove-btn').addEventListener('click',()=>row.remove());
        idx++;
      }

      addRow();
      document.getElementById('addProduct').addEventListener('click',()=>addRow());

      document.getElementById('departamento').addEventListener('change',(e)=>{ 
        loadStages(e.target.value);
      });

      document.querySelector('form').addEventListener('submit',(e)=>{
        const prods=[...document.querySelectorAll('.prod-input')].map(s=>s.value.trim());
        const unitsArr=[...document.querySelectorAll('.unit-select')].map(s=>s.value.trim());
        const qtys=[...document.querySelectorAll('.qty-input')].map(s=>s.value.trim());
        const proys=[...document.querySelectorAll('.proyecto-select')].map(s=>s.value.trim());
        let lines=prods.map((p,i)=>`${p}|${proys[i]}|${unitsArr[i]}|${qtys[i]}`);
        document.getElementById('products_json').value=lines.join("\n");
      });

      // Descargar Excel
      document.getElementById('downloadExcel').addEventListener('click', function() {
        const rows = [...document.querySelectorAll('.product-row')].map(row => {
          const prod = row.querySelector('.prod-input').value.trim();
          const proy = row.querySelector('.proyecto-select').value.trim();
          const special = row.querySelector('.proyecto-especial').value.trim();
          const unit = row.querySelector('.unit-select').value.trim();
          const qty = row.querySelector('.qty-input').value.trim();
          return {
            'Producto / Servicio': prod,
            'Proyecto / Departamento': proy === '__other__' ? special : proy,
            'Unidad': unit,
            'Cantidad': qty
          };
        });

        if(rows.length === 0) { alert('No hay productos para exportar'); return; }

        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Requisición');
        XLSX.writeFile(wb, 'Requisicion.xlsx');
      });
    });
  </script>
  <link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#1a73e8">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/static/service-worker.js')
      .then(() => console.log("Service Worker registrado"))
      .catch(err => console.log("SW falló:", err));
  }
</script>

</body>
</html>
